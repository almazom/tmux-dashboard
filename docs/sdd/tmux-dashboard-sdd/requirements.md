# Tmux Dashboard - Functional Requirements

> Status: READY | Last updated: 2026-01-15 (MSK)

## 1. Автостарт и входной поток

### 1.1 Автоматический запуск после SSH

- Система MUST запускать дашборд сразу после интерактивного SSH входа через zsh/oh-my-zsh.
- Система MUST использовать `exec` в `~/.zshrc` или `~/.zprofile`, чтобы заменить shell процессом дашборда.
- Система MUST проверять интерактивность (`[[ $- == *i* ]]`) и отсутствие `TMUX`, чтобы не создавать вложенные сессии.
- Система SHOULD не влиять на неинтерактивные SSH команды (scp/rsync/ssh user@host 'cmd').

### 1.2 Политика выхода

- Система MUST НЕ предоставлять доступ к «сырому» shell по умолчанию.
- Выход из дашборда MUST завершать SSH сессию (logout).

---

## 2. Управление tmux-сессиями

### 2.1 Список сессий

- Система MUST отображать все существующие tmux-сессии.
- Каждая строка MUST показывать: имя, статус (attached/detached), количество окон.
- Система SHOULD обновлять список по горячей клавише `r`.

### 2.2 Присоединение к сессии

- Система MUST присоединять пользователя к выбранной сессии по Enter.
- Присоединение MUST выполняться через `tmux attach-session -t <name>` как дочерний процесс.
- После detach (`Ctrl+b, d`) пользователь MUST вернуться в дашборд.

### 2.3 Создание новой сессии

- Система MUST позволять создать новую сессию (`n`) с запросом имени.
- Система MUST валидировать имя (не пустое, без пробелов по умолчанию).
- После создания система SHOULD автоматически присоединяться к новой сессии.

### 2.4 Удаление сессии

- Система MUST поддерживать удаление выбранной сессии (`d`) с подтверждением.
- Если сессия attached, система MUST показывать предупреждение о разрыве.
- В режиме dry-run удаление MUST быть заблокировано с информирующим сообщением.

---

## 3. Пользовательский интерфейс (curses)

### 3.1 Основной экран

- Система MUST отображать полноэкранный список сессий и статус-строку.
- Система MUST выделять текущий выбор цветом/инверсией.
- Система SHOULD показывать подсказки по клавишам в нижней строке.

### 3.2 Поиск и фильтрация

- Система MUST поддерживать режим поиска (`/`) по подстроке имени.
- В режиме поиска MUST отображаться строка ввода и текущий фильтр.
- `Esc` MUST сбрасывать фильтр и возвращать полный список.

### 3.3 Предпросмотр

- Система MUST отображать предпросмотр выбранной сессии (список окон/панелей).
- Для каждой панели SHOULD показываться `pane_current_command`.
- Предпросмотр MUST работать без чтения внешних JSONL логов.

### 3.4 Справка

- Система SHOULD предоставлять окно справки (`F1` или `?`) с перечнем горячих клавиш.

---

## 4. Архитектура модулей

- Система SHOULD быть разделена на модули:
  - `app.py` (entrypoint, цикл приложения)
  - `tmux_manager.py` (взаимодействие с tmux)
  - `ui.py` (отрисовка)
  - `input_handler.py` (клавиатура и действия)
  - `models.py` (структуры данных для UI)

---

## 5. Нефункциональные требования

### 5.1 Производительность

- Время реакции на клавиши MUST быть < 100 мс.
- Работа с 100+ сессиями MUST оставаться отзывчивой.

### 5.2 Надежность

- При отсутствии tmux сервера система MUST показывать пустое состояние и предлагать создать сессию.
- Ошибки tmux MUST отображаться в статус-строке и логироваться.
- Система MUST предотвращать запуск нескольких экземпляров одновременно (single instance enforcement).
- Автоматическое создание сессии MUST быть защищено от гонок (race condition protection).

### 5.3 Безопасность

- По умолчанию доступ к shell MUST быть закрыт.
- Действия удаления MUST требовать подтверждения.

### 5.4 Локализация

- UI язык: English (ключевые сообщения и подсказки).

---

## 6. Логирование

- Формат логов MUST быть JSONL (по одной записи на строку).
- Логи SHOULD писаться в `~/.local/state/tmux-dashboard/log.jsonl`.
- Каждая запись MUST содержать поля:
  - `ts` (ISO 8601, MSK, например `2026-01-15T17:12:23+03:00`)
  - `level` (INFO/WARN/ERROR)
  - `event` (например `session_list`, `attach`, `create`, `delete`, `error`)
  - `session_name` (если применимо)
  - `message` (короткое описание)

---

## 7. Конфигурация

### 7.1 Файл конфигурации

```json
{
  "log_path": "~/.local/state/tmux-dashboard/log.jsonl",
  "color": "auto",
  "preview_lines": 10,
  "dry_run": false,
  "auto_rename_on_detach": true
}
```

### 7.2 Переменные окружения

| Env Variable | Purpose | Default |
|--------------|---------|---------|
| `TMUX_DASHBOARD_CONFIG` | Путь к конфигу | `~/.config/tmux-dashboard/config.json` |
| `TMUX_DASHBOARD_LOG` | Путь к JSONL логам | `~/.local/state/tmux-dashboard/log.jsonl` |
| `TMUX_DASHBOARD_COLOR` | `auto|always|never` | `auto` |
| `TMUX_DASHBOARD_PREVIEW_LINES` | Кол-во строк предпросмотра | `10` |
| `TMUX_DASHBOARD_DRY_RUN` | Блокировка разрушительных действий | `false` |
| `TMUX_DASHBOARD_AUTO_RENAME_ON_DETACH` | Авто-синхронизация имен при выходе | `true` |

---

## 8. Ограничения и зависимости

- Linux сервер, root доступ доступен, но не обязателен.
- Оболочка: zsh + oh-my-zsh.
- Python 3.11+, tmux установлен.
- Внешние зависимости допустимы; предпочтение libtmux.

---

## 9. Риски и смягчения

- Риск: поломка терминала после attach/detach.
  - Смягчение: корректный `curses.endwin()` и повторная инициализация после возвращения.
- Риск: автозапуск мешает неинтерактивным SSH вызовам.
  - Смягчение: строгая проверка интерактивности и `TMUX`.
- Риск: удаление активной сессии.
  - Смягчение: явное подтверждение и предупреждение.

---

## 10. Вехи

- Один этап поставки (single-phase delivery).

---

## References

- Related to: tmux session management, curses UI
- Files: `src/tmux_dashboard/*`, `~/.zshrc`, `~/.zprofile`
